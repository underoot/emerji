(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))t(l);new MutationObserver(l=>{for(const n of l)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function o(l){const n={};return l.integrity&&(n.integrity=l.integrity),l.referrerPolicy&&(n.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?n.credentials="include":l.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(l){if(l.ep)return;l.ep=!0;const n=o(l);fetch(l.href,n)}})();const j=5,w=["&#x1FAF1;","&#x1FAF2;","&#x1F468;","&#x1F469;","&#x1F527;","&#x1F373;"],A=new Map([[1,2],[2,4],[3,6]]),M=new Map([["1FAF1",1],["1FAF2",1],["1FAF1;1FAF2",2],["1F468",3],["1F469",3],["1F468;1F527",5],["1F373;1F468",5],["1F469;1F527",5],["1F373;1F469",5]]),z=new Set(["1F527","1F373"]),k=e=>e==="1F3FB"||e==="1F3FC"||e==="1F3FD"||e==="1F3FE"||e==="1F3FF",E=e=>e==="200D",I=e=>{switch(e){case"1F3FB":return 1;case"1F3FC":return 2;case"1F3FD":return 3;case"1F3FE":return 4;case"1F3FF":return 5;default:return 1}};function S(e){return Math.min(Math.floor(e/16)+1,3)}const v=new Map([["1FAF1;1FAF2","1FAF1;1FAF2"],["1F468;1F527","1F468;1F527"],["1F373;1F468","1F468;1F373"],["1F469;1F527","1F469;1F527"],["1F373;1F469","1F469;1F373"]]);function D(e=j){let r=[];for(let t=0;t<e;t++)r[t]=new Array(e).fill(null);const o=Number.parseInt(localStorage.getItem("best_score")??"0");return document.querySelector("#best-score").innerHTML=o.toString(),{size:e,cells:r,score:0,best_score:o}}function J(e,{selector:r}){const o=document.querySelector(r),t=document.querySelector("#score"),l=document.querySelector("#best-score");if(!o)throw new Error(`Cannot construct game field: ${r} not found`);if(!t)throw new Error("Cannot construct game field: #score not found");for(let n=0;n<e.size;n++){const i=document.createElement("tr");i.classList.add("field__row"),o.appendChild(i);for(let s=0;s<e.size;s++){const c=document.createElement("td");c.classList.add("field__cell"),i.appendChild(c)}}e.field={root:o,score:t,best_score:l}}function P(e){const r=S(e.score),o=Math.min(A.get(r)??1,w.length);return w[Math.floor(Math.random()*o)]}function d(e,r,o){return e.cells[o][r]}function C(e,r,o){e.cells[o][r]=null}function O(e,r,o,t){e.cells[o][r]=t}function $(e,r,o){var t;return((t=d(e,r,o))==null?void 0:t.element)??null}function b(e,r,o){const t={x:0,y:0};if(!e.field)throw new Error("Game is not initialized");const l=getComputedStyle(e.field.root),n=l.getPropertyValue("--tile-size"),i=l.getPropertyValue("--padding-size"),s=n?parseInt(n):0,c=i?parseInt(i):0;return t.x=r*(s+c)+c,t.y=o*(s+c)+c,t}function _(e,r,o,t=!1,l){const n=d(e,r,o);if(n){const i=n.element.querySelector(".field__tile");i.classList.add("field__tile-container_destroy"),i.addEventListener("transitionend",()=>{n.element.remove()},{once:!0}),t&&l&&T(e,r,o,l),C(e,r,o)}}function T(e,r,o,t){if(!e.field)throw new Error("Game is not initialized");const l=M.get(t);if(!l)return;const n=document.createElement("div");n.classList.add("field__score-up");const i=document.createElement("div");i.classList.add("field__score-up-text"),i.textContent=`+${l}`,n.appendChild(i);const{x:s,y:c}=b(e,r,o);n.style.left=`${s}px`,n.style.top=`${c}px`,e.field.root.appendChild(n),requestAnimationFrame(()=>{n.classList.add("field__score-up_animate")}),n.addEventListener("animationend",()=>{n.remove()},{once:!0})}function y(e,r){if(!e.field)throw new Error("Game is not initialized");const o=d(e,r.from.x,r.from.y),t=d(e,r.to.x,r.to.y);if(!o)throw new Error("Cannot move from empty cell");o.element.classList.add("field__tile-container_move");const{x:l,y:n}=b(e,r.to.x,r.to.y);C(e,r.from.x,r.from.y),t||O(e,r.to.x,r.to.y,o),o.element.addEventListener("transitionend",()=>{o.element.classList.remove("field__tile-container_move"),r.destroy&&o.element.remove(),r.to_value&&m(e,r.to.x,r.to.y,r.to_value)},{once:!0}),o.element.style.setProperty("transform",`translate(${l}px, ${n}px)`)}function g(e,r,o,t){if(!e.field)throw new Error("Game is not initialized");if($(e,r,o))throw new Error("Tile already exists");const n=document.createElement("div");n.classList.add("field__tile-container");const i=document.createElement("div");i.classList.add("field__tile"),n.appendChild(i),O(e,r,o,{value:t,element:n});const{x:s,y:c}=b(e,r,o);n.style.setProperty("transform",`translate(${s}px, ${c}px)`),i.innerHTML=t,i.addEventListener("animationend",()=>{i.classList.remove("field__tile_appear")},{once:!0}),i.classList.add("field__tile_appear"),e.field.root.appendChild(n)}function m(e,r,o,t){const l=d(e,r,o);if(l){const n=l.element.querySelector(".field__tile");if(l.value=t,n){const i=t.split(";"),c=i.map(u=>u.replace(/(?:&#x)|;/g,"")).filter(u=>k(u)).map(u=>Number.parseInt(u,16)-127994).reduce((u,f)=>u+f,0)*5,a=getComputedStyle(n).getPropertyValue("--base-color").slice(1);n.style.setProperty("--base-color",`#${a.match(/.{1,2}/g).map(u=>{const f=Number.parseInt(u,16)-c;return f<0?"00":f.toString(16)}).join("")}`),i[0]==="&#x1FAF1"&&i.length===5&&i[1]===i[4]?n.innerHTML=`ðŸ¤${i[1]}`:n.innerHTML=t,n.addEventListener("animationend",()=>{n.classList.remove("field__tile_appear")}),n.classList.add("field__tile_appear")}}}function N(e){const r=P(e);let o=!1;for(;!o;){const t=Math.floor(Math.random()*e.size),l=Math.floor(Math.random()*e.size);d(e,t,l)===null&&(g(e,t,l,r),o=!0)}}function L(e){const r={key:"",skin_colors:{}};return r.key=e.split(";").map(o=>o.replace(/(?:&#x)|;/g,"")).filter((o,t,l)=>k(o)&&t>0?(r.skin_colors[l[t-1]]=I(o),null):E(o)?null:(t>0&&!k(l[t-1])&&!E(l[t-1])&&(r.skin_colors[l[t-1]]=z.has(l[t-1])?0:1),o)).filter(Boolean).map(o=>Number.parseInt(o,16)).sort((o,t)=>o-t).map(o=>o.toString(16).toUpperCase()).join(";"),r}function G(e,r){const o={};for(let[l,n]of Object.entries(e.skin_colors))o[l]=n;for(let[l,n]of Object.entries(r.skin_colors))o[l]?o[l]+=n:o[l]=n;return{key:v.has(e.key)?v.get(e.key):e.key,skin_colors:o}}function q(...e){return e.flatMap(r=>r.split(";")).map(r=>Number.parseInt(r,16)).sort((r,o)=>r-o).map(r=>r.toString(16)).join(";").toUpperCase()}function x(e){return e.key.split(";").map(r=>{const o=e.skin_colors[r]??0;return`&#x${r}${o>0?`;&#x${(o+127994).toString(16).toUpperCase()}`:""}`}).join(";&#x200D;")}function F(e,r){const o=L(e),t=L(r);if(o.key===t.key&&!z.has(o.key))return G(o,t);const l=q(o.key,t.key);if(v.has(l)){const n={};for(let[i,s]of Object.entries(o.skin_colors))n[i]=s;for(let[i,s]of Object.entries(t.skin_colors))n[i]?n[i]+=s:n[i]=s;return{key:v.get(l),skin_colors:n}}return null}function H(e){for(let r=0;r<e.size;r++)for(let o=0;o<e.size;o++){const t=d(e,r,o);if(!t)return!1;if(r+1<e.size){const l=d(e,r+1,o);if(F((t==null?void 0:t.value)??"",(l==null?void 0:l.value)??""))return!1}if(o+1<e.size){const l=d(e,r,o+1);if(F((t==null?void 0:t.value)??"",(l==null?void 0:l.value)??""))return!1}}return!0}function U(e){return e.replace(/&#x/g,"").split(";").filter(Boolean).map(r=>String.fromCodePoint(Number.parseInt(r,16))).join("")}function B(e){e.is_finished=!0;const r=document.createElement("div");r.classList.add("field__buttons");const o=document.createElement("button");o.classList.add("field__replay-button"),o.innerHTML="ðŸ”„",o.addEventListener("click",()=>{location.reload()},{once:!0});const t=document.createElement("button");if(t.classList.add("field__share-button"),t.innerHTML="ðŸ“¤",!e.field)throw new Error("Game is not initialized");r.appendChild(o),r.appendChild(t),t.addEventListener("click",()=>{let l="";for(let i=0;i<e.size;i++){for(let s=0;s<e.size;s++){const c=d(e,i,s);c?l+=U(c.value):l+=" "}l+=`
`}const n=`And my field looks like this:

${l}`;if(navigator.share)navigator.share({title:`I scored ${e.score} in Emerji`,text:n,url:window.location.href});else{const i=document.createElement("textarea");i.value=`My score is ${e.score}!

`+n+`

`+window.location.href,document.body.appendChild(i),i.focus(),i.select(),document.execCommand("copy"),document.body.removeChild(i)}}),e.field.root.appendChild(r)}function h(e,r){if(!e.field)throw new Error("Game is not initialized");const o=e.score+(M.get(r)??0),t=S(o);o>e.best_score&&(localStorage.setItem("best_score",o.toString()),e.best_score=o,e.field.best_score.innerHTML=o.toString()),e.score=o,e.field.score.innerHTML=o.toString(),e.field.root.style.setProperty("--level",t.toString())}function R(e,r){if(e.is_finished)return;let o=!1;switch(r){case"down":{for(let t=0;t<e.size;t++){let l=!1,n=null,i={x:0,y:0};for(let s=e.size-1;s>=0;s--){let c=d(e,t,s);if(!c)continue;if(!l&&n){const f=F(c.value,n.value);if(f){if(Object.values(f.skin_colors).some(p=>p>5)){h(e,f.key),_(e,t,s),_(e,i.x,i.y,!0,f.key),l=!0;continue}o=!0,l=!0,y(e,{from:{x:t,y:s},to:i,destroy:!0}),m(e,i.x,i.y,x(f));continue}else n=c,i={x:t,y:s}}n||(n=c,i={x:t,y:s});let a=!1,u=s;for(;!a&&u<e.size;){let f=d(e,t,u);if(f&&c!==f){a=!0;break}u++}u-1!=s&&(o=!0,y(e,{from:{x:t,y:s},to:{x:t,y:u-1},destroy:!1}),l||(i={x:t,y:u-1}))}}break}case"up":{for(let t=0;t<e.size;t++){let l=!1,n=null,i={x:0,y:0};for(let s=0;s<e.size;s++){let c=d(e,t,s);if(!c)continue;if(!l&&n){const f=F(c.value,n.value);if(f){if(Object.values(f.skin_colors).some(p=>p>5)){h(e,f.key),_(e,t,s),_(e,i.x,i.y,!0,f.key),l=!0;continue}o=!0,l=!0,y(e,{from:{x:t,y:s},to:i,destroy:!0}),m(e,i.x,i.y,x(f));continue}else n=c,i={x:t,y:s}}n||(n=c,i={x:t,y:s});let a=!1,u=s;for(;!a&&u>=0;){let f=d(e,t,u);if(f&&c!==f){a=!0;break}u--}u+1!=s&&(o=!0,y(e,{from:{x:t,y:s},to:{x:t,y:u+1},destroy:!1}),l||(i={x:t,y:u+1}))}}break}case"left":{for(let t=0;t<e.size;t++){let l=!1,n=null,i={x:0,y:0};for(let s=0;s<e.size;s++){let c=d(e,s,t);if(!c)continue;if(!l&&n){const f=F(c.value,n.value);if(f){if(Object.values(f.skin_colors).some(p=>p>5)){h(e,f.key),_(e,s,t),_(e,i.x,i.y,!0,f.key),l=!0;continue}o=!0,l=!0,y(e,{from:{x:s,y:t},to:i,destroy:!0}),m(e,i.x,i.y,x(f));continue}else n=c,i={x:s,y:t}}n||(n=c,i={x:s,y:t});let a=!1,u=s;for(;!a&&u>=0;){let f=d(e,u,t);if(f&&c!==f){a=!0;break}u--}u+1!=s&&(o=!0,y(e,{from:{x:s,y:t},to:{x:u+1,y:t},destroy:!1}),l||(i={x:u+1,y:t}))}}break}case"right":{for(let t=0;t<e.size;t++){let l=!1,n=null,i={x:0,y:0};for(let s=e.size-1;s>=0;s--){let c=d(e,s,t);if(!c)continue;if(!l&&n){const f=F(c.value,n.value);if(f){if(Object.values(f.skin_colors).some(p=>p>5)){h(e,f.key),_(e,s,t),_(e,i.x,i.y,!0,f.key),l=!0;continue}o=!0,l=!0,y(e,{from:{x:s,y:t},to:i,destroy:!0}),m(e,i.x,i.y,x(f));continue}else n=c,i={x:s,y:t}}n||(n=c,i={x:s,y:t});let a=!1,u=s;for(;!a&&u<e.size;){let f=d(e,u,t);if(f&&c!==f){a=!0;break}u++}u-1!=s&&(o=!0,y(e,{from:{x:s,y:t},to:{x:u-1,y:t},destroy:!1}),l||(i={x:u-1,y:t}))}}break}}o&&(N(e),H(e)&&B(e))}export{J as a,N as b,R as c,D as g};
