(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const N=5,E=["&#x1FAF1;","&#x1FAF2;","&#x1F468;","&#x1F469;","&#x1F527;","&#x1F373;"],G=new Map([[1,2],[2,4],[3,6]]),H=new Map([["1FAF1",1],["1FAF2",1],["1FAF1;1FAF2",2],["1F468",3],["1F469",3],["1F468;1F527",5],["1F373;1F468",5],["1F469;1F527",5],["1F373;1F469",5]]),g=new Set(["1F527","1F373"]),v=e=>e==="1F3FB"||e==="1F3FC"||e==="1F3FD"||e==="1F3FE"||e==="1F3FF",L=e=>e==="200D",q=e=>{switch(e){case"1F3FB":return 1;case"1F3FC":return 2;case"1F3FD":return 3;case"1F3FE":return 4;case"1F3FF":return 5;default:return 1}};function C(e){return Math.floor(e/16)+1}const w=new Map([["1FAF1;1FAF2","1FAF1;1FAF2"],["1F468;1F527","1F468;1F527"],["1F373;1F468","1F468;1F373"],["1F469;1F527","1F469;1F527"],["1F373;1F469","1F469;1F373"]]);function X(e=N){let r=[];for(let t=0;t<e;t++)r[t]=new Array(e).fill(null);const o=Number.parseInt(localStorage.getItem("best_score")??"0");return document.querySelector("#best-score").innerHTML=o.toString(),{size:e,cells:r,score:0,best_score:o}}function Y(e,{selector:r}){const o=document.querySelector(r),t=document.querySelector("#score"),n=document.querySelector("#best-score");if(!o)throw new Error(`Cannot construct game field: ${r} not found`);if(!t)throw new Error("Cannot construct game field: #score not found");for(let s=0;s<e.size;s++){const l=document.createElement("tr");l.classList.add("field__row"),o.appendChild(l);for(let i=0;i<e.size;i++){const c=document.createElement("td");c.classList.add("field__cell"),l.appendChild(c)}}e.field={root:o,score:t,best_score:n}}function D(e){const r=C(e.score),o=Math.min(G.get(r)??1,E.length);return E[Math.floor(Math.random()*o)]}function a(e,r,o){return e.cells[o][r]}function A(e,r,o){e.cells[o][r]=null}function O(e,r,o,t){e.cells[o][r]=t}function R(e,r,o){var t;return((t=a(e,r,o))==null?void 0:t.element)??null}function j(e,r,o){const t={x:0,y:0};if(!e.field)throw new Error("Game is not initialized");const n=getComputedStyle(e.field.root),s=n.getPropertyValue("--tile-size"),l=n.getPropertyValue("--padding-size"),i=s?parseInt(s):0,c=l?parseInt(l):0;return t.x=r*(i+c)+c,t.y=o*(i+c)+c,t}function y(e,r,o){const t=a(e,r,o);if(t){const n=t.element.querySelector(".field__tile");n.classList.add("field__tile-container_destroy"),n.addEventListener("transitionend",()=>{t.element.remove()},{once:!0}),A(e,r,o)}}function p(e,r){if(!e.field)throw new Error("Game is not initialized");const o=a(e,r.from.x,r.from.y),t=a(e,r.to.x,r.to.y);if(!o)throw new Error("Cannot move from empty cell");o.element.classList.add("field__tile-container_move");const{x:n,y:s}=j(e,r.to.x,r.to.y);A(e,r.from.x,r.from.y),t||O(e,r.to.x,r.to.y,o),o.element.addEventListener("transitionend",()=>{o.element.classList.remove("field__tile-container_move"),r.destroy&&o.element.remove(),r.to_value&&x(e,r.to.x,r.to.y,r.to_value)},{once:!0}),o.element.style.setProperty("transform",`translate(${n}px, ${s}px)`)}function B(e,r,o,t){if(!e.field)throw new Error("Game is not initialized");if(R(e,r,o))throw new Error("Tile already exists");const s=document.createElement("div");s.classList.add("field__tile-container");const l=document.createElement("div");l.classList.add("field__tile"),s.appendChild(l),O(e,r,o,{value:t,element:s});const{x:i,y:c}=j(e,r,o);s.style.setProperty("transform",`translate(${i}px, ${c}px)`),l.innerHTML=t,l.addEventListener("animationend",()=>{l.classList.remove("field__tile_appear")},{once:!0}),l.classList.add("field__tile_appear"),e.field.root.appendChild(s)}function x(e,r,o,t){const n=a(e,r,o);if(n){const s=n.element.querySelector(".field__tile");if(n.value=t,s){const l=t.split(";"),c=l.map(f=>f.replace(/(?:&#x)|;/g,"")).filter(f=>v(f)).map(f=>Number.parseInt(f,16)-127994).reduce((f,u)=>f+u,0)*5,d=getComputedStyle(s).getPropertyValue("--base-color").slice(1);s.style.setProperty("--base-color",`#${d.match(/.{1,2}/g).map(f=>{const u=Number.parseInt(f,16)-c;return u<0?"00":u.toString(16)}).join("")}`),l[0]==="&#x1FAF1"&&l.length===5&&l[1]===l[4]?s.innerHTML=`🤝${l[1]}`:s.innerHTML=t,s.addEventListener("animationend",()=>{s.classList.remove("field__tile_appear")}),s.classList.add("field__tile_appear")}}}function I(e){const r=D(e);let o=!1;for(;!o;){const t=Math.floor(Math.random()*e.size),n=Math.floor(Math.random()*e.size);a(e,t,n)===null&&(B(e,t,n,r),o=!0)}}function M(e){const r={key:"",skin_colors:{}};return r.key=e.split(";").map(o=>o.replace(/(?:&#x)|;/g,"")).filter((o,t,n)=>v(o)&&t>0?(r.skin_colors[n[t-1]]=q(o),null):L(o)?null:(t>0&&!v(n[t-1])&&!L(n[t-1])&&(r.skin_colors[n[t-1]]=g.has(n[t-1])?0:1),o)).filter(Boolean).map(o=>Number.parseInt(o,16)).sort((o,t)=>o-t).map(o=>o.toString(16).toUpperCase()).join(";"),r}function J(e,r){const o={};for(let[n,s]of Object.entries(e.skin_colors))o[n]=s;for(let[n,s]of Object.entries(r.skin_colors))o[n]?o[n]+=s:o[n]=s;return{key:w.has(e.key)?w.get(e.key):e.key,skin_colors:o}}function U(...e){return e.flatMap(r=>r.split(";")).map(r=>Number.parseInt(r,16)).sort((r,o)=>r-o).map(r=>r.toString(16)).join(";").toUpperCase()}function b(e){return e.key.split(";").map(r=>{const o=e.skin_colors[r]??0;return`&#x${r}${o>0?`;&#x${(o+127994).toString(16).toUpperCase()}`:""}`}).join(";&#x200D;")}function m(e,r){const o=M(e),t=M(r);if(o.key===t.key&&!g.has(o.key))return J(o,t);const n=U(o.key,t.key);if(w.has(n)){const s={};for(let[l,i]of Object.entries(o.skin_colors))s[l]=i;for(let[l,i]of Object.entries(t.skin_colors))s[l]?s[l]+=i:s[l]=i;return{key:w.get(n),skin_colors:s}}return null}function V(e){for(let r=0;r<e.size;r++)for(let o=0;o<e.size;o++){const t=a(e,r,o);if(!t)return!1;if(r+1<e.size){const n=a(e,r+1,o);if(m((t==null?void 0:t.value)??"",(n==null?void 0:n.value)??""))return!1}if(o+1<e.size){const n=a(e,r,o+1);if(m((t==null?void 0:t.value)??"",(n==null?void 0:n.value)??""))return!1}}return!0}function K(e){return e.replace(/&#x/g,"").split(";").filter(Boolean).map(r=>String.fromCodePoint(Number.parseInt(r,16))).join("")}function Z(e){e.is_finished=!0;const r=document.createElement("div");r.classList.add("field__buttons");const o=document.createElement("button");o.classList.add("field__replay-button"),o.innerHTML="🔄",o.addEventListener("click",()=>{location.reload()},{once:!0});const t=document.createElement("button");if(t.classList.add("field__share-button"),t.innerHTML="📤",!e.field)throw new Error("Game is not initialized");r.appendChild(o),r.appendChild(t),t.addEventListener("click",()=>{let n="";for(let l=0;l<e.size;l++){for(let i=0;i<e.size;i++){const c=a(e,l,i);c?n+=K(c.value):n+=" "}n+=`
`}const s=`My score is ${e.score}! and my field looks like this:

${n}`;if(navigator.share)navigator.share({title:"Emerji",text:s,url:window.location.href});else{const l=document.createElement("textarea");l.value=s+`

`+window.location.href,document.body.appendChild(l),l.focus(),l.select(),document.execCommand("copy"),document.body.removeChild(l)}}),e.field.root.appendChild(r)}function k(e,r){if(!e.field)throw new Error("Game is not initialized");const o=e.score+(H.get(r)??0),t=C(o);o>e.best_score&&(localStorage.setItem("best_score",o.toString()),e.best_score=o,e.field.best_score.innerHTML=o.toString()),e.score=o,e.field.score.innerHTML=o.toString(),e.field.root.style.setProperty("--level",t.toString())}function h(e,r){if(e.is_finished)return;let o=!1;switch(r){case"down":{for(let t=0;t<e.size;t++){let n=!1,s=null,l={x:0,y:0};for(let i=e.size-1;i>=0;i--){let c=a(e,t,i);if(!c)continue;if(!n&&s){const u=m(c.value,s.value);if(u){if(Object.values(u.skin_colors).some(F=>F>5)){k(e,u.key),y(e,t,i),y(e,l.x,l.y),n=!0;continue}o=!0,n=!0,p(e,{from:{x:t,y:i},to:l,destroy:!0}),x(e,l.x,l.y,b(u));continue}else s=c,l={x:t,y:i}}s||(s=c,l={x:t,y:i});let d=!1,f=i;for(;!d&&f<e.size;){let u=a(e,t,f);if(u&&c!==u){d=!0;break}f++}f-1!=i&&(o=!0,p(e,{from:{x:t,y:i},to:{x:t,y:f-1},destroy:!1}),n||(l={x:t,y:f-1}))}}break}case"up":{for(let t=0;t<e.size;t++){let n=!1,s=null,l={x:0,y:0};for(let i=0;i<e.size;i++){let c=a(e,t,i);if(!c)continue;if(!n&&s){const u=m(c.value,s.value);if(u){if(Object.values(u.skin_colors).some(F=>F>5)){k(e,u.key),y(e,t,i),y(e,l.x,l.y),n=!0;continue}o=!0,n=!0,p(e,{from:{x:t,y:i},to:l,destroy:!0}),x(e,l.x,l.y,b(u));continue}else s=c,l={x:t,y:i}}s||(s=c,l={x:t,y:i});let d=!1,f=i;for(;!d&&f>=0;){let u=a(e,t,f);if(u&&c!==u){d=!0;break}f--}f+1!=i&&(o=!0,p(e,{from:{x:t,y:i},to:{x:t,y:f+1},destroy:!1}),n||(l={x:t,y:f+1}))}}break}case"left":{for(let t=0;t<e.size;t++){let n=!1,s=null,l={x:0,y:0};for(let i=0;i<e.size;i++){let c=a(e,i,t);if(!c)continue;if(!n&&s){const u=m(c.value,s.value);if(u){if(Object.values(u.skin_colors).some(F=>F>5)){k(e,u.key),y(e,i,t),y(e,l.x,l.y),n=!0;continue}o=!0,n=!0,p(e,{from:{x:i,y:t},to:l,destroy:!0}),x(e,l.x,l.y,b(u));continue}else s=c,l={x:i,y:t}}s||(s=c,l={x:i,y:t});let d=!1,f=i;for(;!d&&f>=0;){let u=a(e,f,t);if(u&&c!==u){d=!0;break}f--}f+1!=i&&(o=!0,p(e,{from:{x:i,y:t},to:{x:f+1,y:t},destroy:!1}),n||(l={x:f+1,y:t}))}}break}case"right":{for(let t=0;t<e.size;t++){let n=!1,s=null,l={x:0,y:0};for(let i=e.size-1;i>=0;i--){let c=a(e,i,t);if(!c)continue;if(!n&&s){const u=m(c.value,s.value);if(u){if(Object.values(u.skin_colors).some(F=>F>5)){k(e,u.key),y(e,i,t),y(e,l.x,l.y),n=!0;continue}o=!0,n=!0,p(e,{from:{x:i,y:t},to:l,destroy:!0}),x(e,l.x,l.y,b(u));continue}else s=c,l={x:i,y:t}}s||(s=c,l={x:i,y:t});let d=!1,f=i;for(;!d&&f<e.size;){let u=a(e,f,t);if(u&&c!==u){d=!0;break}f++}f-1!=i&&(o=!0,p(e,{from:{x:i,y:t},to:{x:f-1,y:t},destroy:!1}),n||(l={x:f-1,y:t}))}}break}}o&&(I(e),V(e)&&Z(e))}const _=X();Y(_,{selector:"#game"});I(_);document.body.addEventListener("keydown",e=>{switch(e.key){case"ArrowUp":h(_,"up");break;case"ArrowDown":h(_,"down");break;case"ArrowLeft":h(_,"left");break;case"ArrowRight":h(_,"right");break}});let T=0,P=0,S=0,z=0;const $=document.body;$.addEventListener("touchstart",e=>{T=e.changedTouches[0].screenX,P=e.changedTouches[0].screenY});$.addEventListener("touchend",e=>{S=e.changedTouches[0].screenX,z=e.changedTouches[0].screenY;const r=S-T,o=z-P;Math.abs(r)>Math.abs(o)?r>0?h(_,"right"):h(_,"left"):o>0?h(_,"down"):h(_,"up")});
